import { providers } from "near-api-js";

export default async function handler(req, res) {

  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  const { transactionHash, accountId } = req.body;

  if (!transactionHash) {
    return res.status(400).json({
      error: "transactionHash required"
    });
  }

  try {
    const provider = new providers.JsonRpcProvider({
      url: "https://rpc.mainnet.near.org"
    });

    // Agar accountId diya hai to use karo
    // Warna transaction se signer extract karenge
    let signer = accountId;

    if (!signer) {
      const tx = await provider.txStatus(transactionHash, "near");
      signer = tx?.transaction?.signer_id;
    }

    const result = await provider.txStatus(transactionHash, signer);

    if (result?.status && typeof result.status.SuccessValue === "string") {
      return res.status(200).json({
        success: true,
        access: "granted"
      });
    }

    return res.status(200).json({
      success: false,
      message: "Transaction failed"
    });

  } catch (error) {
    return res.status(200).json({
      success: false,
      message: "Verification failed"
    });
  }
}